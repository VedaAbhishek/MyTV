<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>YouTube TV</title>
    <style>
      body {
        margin: 0;
        background: black;
        overflow: hidden;
      }
      iframe {
        width: 100vw;
        height: 100vh;
        border: none;
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      .settings-link {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: white;
        color: black;
        padding: 10px 12px;
        text-decoration: none;
        border-radius: 8px;
        font-family: Arial, sans-serif;
        font-weight: bold;
        font-size: 16px;
      }
      .message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 32px;
        text-align: center;
        z-index: 2;
        transition: opacity 1s ease;
      }
    </style>
  </head>
  <body>
    <a href="/settings" class="settings-link">Settings</a>
    <iframe id="player" allow="autoplay; fullscreen"></iframe>
    <div id="message" class="message">No Videos Scheduled</div>

    <script th:inline="javascript">
      const videos = [[${videos}]].map(v => ({
        link: v.youtubeLink,
        duration: v.durationInSeconds * 1000,
        date: v.scheduledDate,
        time: v.scheduledTime
      }));

      const player = document.getElementById("player");
      const msg = document.getElementById("message");
      let playing = false;

      function isNow(video) {
        const now = new Date();
        const start = new Date(video.date + "T" + video.time);
        const end = new Date(start.getTime() + video.duration);
        return now >= start && now <= end;
      }

      function checkSchedule() {
        const now = new Date();
        const current = videos.find(isNow);

        if (current) {
          const startTime = new Date(current.date + "T" + current.time);
          const endTime = new Date(startTime.getTime() + current.duration);
          const remainingMs = endTime - now;

          // --- Implementation control variables ---
          const stored = JSON.parse(sessionStorage.getItem("currentVideo") || "{}");
          const sameVideo = stored.link === current.link;

          let startParam;

          if (!sameVideo) {
            // ðŸ§© Case 1: Fresh login (new session or different video)
            // Always start from beginning (0)
            startParam = 0;
            sessionStorage.setItem(
              "currentVideo",
              JSON.stringify({ link: current.link, startedAt: now.toISOString() })
            );
          } else {
            // ðŸ§© Case 2: Returning to same video after going to settings
            // Continue according to real-time clock
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            startParam = elapsedSeconds > 0 ? elapsedSeconds : 0;
          }

          if (!playing) {
            playing = true;
            msg.style.opacity = "0";
            player.style.display = "block";

            player.src = `${current.link}?autoplay=1&mute=1&start=${startParam}`;

            // Stop exactly at scheduled end time
            setTimeout(() => {
              player.src = "";
              player.style.display = "none";
              msg.innerText = "No Videos Scheduled";
              msg.style.opacity = "1";
              playing = false;
              sessionStorage.removeItem("currentVideo");
              checkSchedule();
            }, remainingMs + 500);
          }
        } else {
          // No current video
          playing = false;
          player.style.display = "none";
          sessionStorage.removeItem("currentVideo");

          // Show countdown to next video
          const now = new Date();
          const futureVideos = videos
            .map(v => ({ ...v, timeObj: new Date(v.date + "T" + v.time) }))
            .filter(v => v.timeObj > now)
            .sort((a, b) => a.timeObj - b.timeObj);

          if (futureVideos.length > 0) {
            const next = futureVideos[0];
            const diffMs = next.timeObj - now;
            const totalSeconds = Math.floor(diffMs / 1000);
            const mins = String(Math.floor(totalSeconds / 60)).padStart(2, "0");
            const secs = String(totalSeconds % 60).padStart(2, "0");
            msg.innerText = `Next video in ${mins}:${secs}`;
          } else {
            msg.innerText = "No Videos Scheduled";
          }
          msg.style.opacity = "1";
        }
      }

      checkSchedule();
      setInterval(checkSchedule, 1000);
    </script>
  </body>
</html>
